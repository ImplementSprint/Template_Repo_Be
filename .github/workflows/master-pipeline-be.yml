# ╔══════════════════════════════════════════════════════════════════╗
# ║  MASTER PIPELINE ORCHESTRATOR (BACKEND — NestJS)               ║
# ║  Branch Strategy: test → uat → main                           ║
# ║                                                                ║
# ║  Calls reusable workflows from Central-Template-main repo     ║
# ║  Replace OWNER/Central-Template-main with your actual repo    ║
# ╚══════════════════════════════════════════════════════════════════╝
name: "Master Pipeline Orchestrator — Backend"

on:
  push:
    branches: [test, uat, main]
  pull_request:
    branches: [test, uat, main]
  workflow_dispatch:
    inputs:
      run_deploy:
        description: "Run deploy jobs"
        type: boolean
        default: true
      run_promotion:
        description: "Run PR promotion jobs"
        type: boolean
        default: true
      dry_run:
        description: "Preview-only mode (skip deploy/tag push, print PR body)"
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  pull-requests: write
  security-events: write

concurrency:
  group: master-pipeline-be-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ══════════════════════════════════════════════════════════════════
  # Detect Changes
  # ══════════════════════════════════════════════════════════════════
  detect-changes:
    name: "Detect Changed Files"
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        with:
          filters: |
            backend:
              - '**'
            shared:
              - '.github/**'
              - 'package.json'
              - 'sonar-project.properties'

  # ══════════════════════════════════════════════════════════════════
  # Resolve Backend Configuration
  # ══════════════════════════════════════════════════════════════════
  systems-config:
    name: "Resolve Backend Configuration"
    runs-on: ubuntu-latest
    outputs:
      system_name: ${{ steps.resolve.outputs.system_name }}
      working_dir: ${{ steps.resolve.outputs.working_dir }}
      image_name: ${{ steps.resolve.outputs.image_name }}
      replit_deploy_secret: ${{ steps.resolve.outputs.replit_deploy_secret }}
    steps:
      - name: Resolve BE single config
        id: resolve
        env:
          BE_SINGLE_SYSTEM_JSON: ${{ vars.BE_SINGLE_SYSTEM_JSON }}
        run: |
          if [ -z "${BE_SINGLE_SYSTEM_JSON}" ]; then
            echo "❌ Missing required repository variable BE_SINGLE_SYSTEM_JSON."
            echo ""
            echo "Set it as a repository variable with this format:"
            echo '{"name":"MyBackend-API","dir":".","image":"mybackend-api","replit_deploy_secret":"REPLIT_DEPLOY_URL"}'
            exit 1
          fi

          CONFIG=$(echo "${BE_SINGLE_SYSTEM_JSON}" | jq -c 'if type == "array" then .[0] else . end')

          echo "${CONFIG}" | jq -e 'type == "object"' >/dev/null
          echo "${CONFIG}" | jq -e '(.name|type=="string" and length>0) and (.dir|type=="string" and length>0) and (.image|type=="string" and length>0)' >/dev/null

          SYSTEM_NAME=$(echo "${CONFIG}" | jq -r '.name')
          WORKING_DIR=$(echo "${CONFIG}" | jq -r '.dir')
          IMAGE_NAME=$(echo "${CONFIG}" | jq -r '.image')
          REPLIT_DEPLOY_SECRET=$(echo "${CONFIG}" | jq -r '.replit_deploy_secret // "REPLIT_DEPLOY_URL"')

          echo "system_name=${SYSTEM_NAME}" >> "$GITHUB_OUTPUT"
          echo "working_dir=${WORKING_DIR}" >> "$GITHUB_OUTPUT"
          echo "image_name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "replit_deploy_secret=${REPLIT_DEPLOY_SECRET}" >> "$GITHUB_OUTPUT"

  # ══════════════════════════════════════════════════════════════════
  # Backend Pipeline (Tests + Lint + Security)
  # ══════════════════════════════════════════════════════════════════
  backend:
    name: "${{ needs.systems-config.outputs.system_name }} Pipeline"
    needs: [detect-changes, systems-config]
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.shared == 'true'
    uses: OWNER/Central-Template-main/.github/workflows/backend-workflow.yml@main
    with:
      system-dir: ${{ needs.systems-config.outputs.working_dir }}
      system-name: ${{ needs.systems-config.outputs.system_name }}
      enable-security-scan: true
      enable-lint: true
      coverage-threshold: 80
    secrets: inherit

  # ══════════════════════════════════════════════════════════════════
  # SonarCloud Quality Gate
  # ══════════════════════════════════════════════════════════════════
  sonarcloud:
    name: "SonarCloud Analysis"
    needs: [backend, systems-config]
    if: >-
      always() &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    uses: OWNER/Central-Template/.github/workflows/sonarcloud-scan.yml@main
    with:
      working-directory: ${{ needs.systems-config.outputs.working_dir }}
      system-name: ${{ needs.systems-config.outputs.system_name }}
      sources-path: src
      tests-path: tests
      coverage-report-path: coverage/lcov.info
      coverage-artifact-name: ${{ needs.systems-config.outputs.system_name }}-coverage
      quality-gate-wait: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

  # ══════════════════════════════════════════════════════════════════
  # Version Tag — TEST
  # ══════════════════════════════════════════════════════════════════
  version-test:
    name: "Version Tag — TEST"
    needs: [backend]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    uses: ImplementSprint/Central-Template/.github/workflows/versioning.yml@main
    with:
      mode: test

  # ══════════════════════════════════════════════════════════════════
  # Deploy TEST (Replit)
  # ══════════════════════════════════════════════════════════════════
  deploy-test:
    name: "TEST — ${{ needs.systems-config.outputs.system_name }}"
    needs: [backend, systems-config]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Replit (TEST)
        id: deploy
        env:
          REPLIT_DEPLOY_URL: ${{ secrets[needs.systems-config.outputs.replit_deploy_secret] }}
          REPLIT_API_KEY: ${{ secrets.REPLIT_API_KEY }}
        run: |
          echo "╔══════════════════════════════════════════════╗"
          echo "║   REPLIT DEPLOYMENT — TEST                   ║"
          echo "╠══════════════════════════════════════════════╣"
          echo "║ System:      ${{ needs.systems-config.outputs.system_name }}"
          echo "║ Environment: test"
          echo "║ Branch:      ${{ github.ref_name }}"
          echo "║ Commit:      ${{ github.sha }}"
          echo "║ Timestamp:   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "╚══════════════════════════════════════════════╝"

          if [ -z "${REPLIT_DEPLOY_URL}" ]; then
            echo "⚠️ REPLIT_DEPLOY_URL secret not set. Skipping Replit deploy."
            echo "deployment_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Trigger Replit deployment via deploy hook
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "${REPLIT_DEPLOY_URL}" \
            -H "Content-Type: application/json" \
            -d "{\"branch\":\"test\",\"commit\":\"${{ github.sha }}\"}" 2>&1 || true)

          HTTP_CODE=$(echo "${RESPONSE}" | tail -n 1)
          BODY=$(echo "${RESPONSE}" | sed '$d')

          if [ "${HTTP_CODE}" = "200" ] || [ "${HTTP_CODE}" = "201" ] || [ "${HTTP_CODE}" = "204" ]; then
            echo "✅ Replit deploy triggered successfully"
            DEPLOY_URL=$(echo "${BODY}" | jq -r '.url // empty' 2>/dev/null || true)
            if [ -z "${DEPLOY_URL}" ]; then
              DEPLOY_URL="${REPLIT_DEPLOY_URL}"
            fi
          else
            echo "⚠️ Replit deploy returned HTTP ${HTTP_CODE}"
            DEPLOY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "deployment_url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"

  # ══════════════════════════════════════════════════════════════════
  # Deploy UAT (Replit)
  # ══════════════════════════════════════════════════════════════════
  deploy-uat:
    name: "UAT — ${{ needs.systems-config.outputs.system_name }}"
    needs: [backend, systems-config]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Replit (UAT)
        id: deploy
        env:
          REPLIT_DEPLOY_URL: ${{ secrets[needs.systems-config.outputs.replit_deploy_secret] }}
          REPLIT_API_KEY: ${{ secrets.REPLIT_API_KEY }}
        run: |
          echo "╔══════════════════════════════════════════════╗"
          echo "║   REPLIT DEPLOYMENT — UAT                    ║"
          echo "╠══════════════════════════════════════════════╣"
          echo "║ System:      ${{ needs.systems-config.outputs.system_name }}"
          echo "║ Environment: uat"
          echo "║ Branch:      ${{ github.ref_name }}"
          echo "║ Commit:      ${{ github.sha }}"
          echo "║ Timestamp:   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "╚══════════════════════════════════════════════╝"

          if [ -z "${REPLIT_DEPLOY_URL}" ]; then
            echo "⚠️ REPLIT_DEPLOY_URL secret not set. Skipping Replit deploy."
            echo "deployment_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "${REPLIT_DEPLOY_URL}" \
            -H "Content-Type: application/json" \
            -d "{\"branch\":\"uat\",\"commit\":\"${{ github.sha }}\"}" 2>&1 || true)

          HTTP_CODE=$(echo "${RESPONSE}" | tail -n 1)
          BODY=$(echo "${RESPONSE}" | sed '$d')

          if [ "${HTTP_CODE}" = "200" ] || [ "${HTTP_CODE}" = "201" ] || [ "${HTTP_CODE}" = "204" ]; then
            echo "✅ Replit deploy triggered successfully"
            DEPLOY_URL=$(echo "${BODY}" | jq -r '.url // empty' 2>/dev/null || true)
            if [ -z "${DEPLOY_URL}" ]; then
              DEPLOY_URL="${REPLIT_DEPLOY_URL}"
            fi
          else
            echo "⚠️ Replit deploy returned HTTP ${HTTP_CODE}"
            DEPLOY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "deployment_url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"

  # ══════════════════════════════════════════════════════════════════
  # Production Readiness Gate
  # ══════════════════════════════════════════════════════════════════
  production-gate:
    name: "Production Readiness Gate"
    needs: [backend, systems-config]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || (github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true')) &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped')
    uses: ImplementSprint/Central-Template/.github/workflows/production-gate.yml@main
    with:
      system-dir: ${{ needs.systems-config.outputs.working_dir }}
      app-type: api
    secrets: inherit

  # ══════════════════════════════════════════════════════════════════
  # Deploy Production (Replit)
  # ══════════════════════════════════════════════════════════════════
  deploy-prod:
    name: "Prod — ${{ needs.systems-config.outputs.system_name }}"
    needs: [production-gate, systems-config]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    runs-on: ubuntu-latest
    outputs:
      deployment_url: ${{ steps.deploy.outputs.deployment_url }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to Replit (PRODUCTION)
        id: deploy
        env:
          REPLIT_DEPLOY_URL: ${{ secrets[needs.systems-config.outputs.replit_deploy_secret] }}
          REPLIT_API_KEY: ${{ secrets.REPLIT_API_KEY }}
        run: |
          echo "╔══════════════════════════════════════════════╗"
          echo "║   REPLIT DEPLOYMENT — PRODUCTION             ║"
          echo "╠══════════════════════════════════════════════╣"
          echo "║ System:      ${{ needs.systems-config.outputs.system_name }}"
          echo "║ Environment: production"
          echo "║ Branch:      ${{ github.ref_name }}"
          echo "║ Commit:      ${{ github.sha }}"
          echo "║ Timestamp:   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "╚══════════════════════════════════════════════╝"

          if [ -z "${REPLIT_DEPLOY_URL}" ]; then
            echo "⚠️ REPLIT_DEPLOY_URL secret not set. Skipping Replit deploy."
            echo "deployment_url=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "${REPLIT_DEPLOY_URL}" \
            -H "Content-Type: application/json" \
            -d "{\"branch\":\"main\",\"commit\":\"${{ github.sha }}\",\"environment\":\"production\"}" 2>&1 || true)

          HTTP_CODE=$(echo "${RESPONSE}" | tail -n 1)
          BODY=$(echo "${RESPONSE}" | sed '$d')

          if [ "${HTTP_CODE}" = "200" ] || [ "${HTTP_CODE}" = "201" ] || [ "${HTTP_CODE}" = "204" ]; then
            echo "✅ Replit production deploy triggered successfully"
            DEPLOY_URL=$(echo "${BODY}" | jq -r '.url // empty' 2>/dev/null || true)
            if [ -z "${DEPLOY_URL}" ]; then
              DEPLOY_URL="${REPLIT_DEPLOY_URL}"
            fi
          else
            echo "⚠️ Replit deploy returned HTTP ${HTTP_CODE}"
            DEPLOY_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "deployment_url=${DEPLOY_URL}" >> "$GITHUB_OUTPUT"

  # ══════════════════════════════════════════════════════════════════
  # Update Repository About Link
  # ══════════════════════════════════════════════════════════════════
  update-about-link:
    name: "Update Repository About Link"
    needs: [deploy-prod]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.deploy-prod.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Update repository homepage URL
        env:
          GH_PR_TOKEN_PRIMARY: ${{ secrets.GH_PR_TOKEN }}
          GH_PR_TOKEN_LEGACY: ${{ secrets.GHPR_TOKEN }}
          DEPLOYMENT_URL: ${{ needs.deploy-prod.outputs.deployment_url }}
        run: |
          GH_TOKEN="${GH_PR_TOKEN_PRIMARY}"
          if [ -z "${GH_TOKEN}" ]; then
            GH_TOKEN="${GH_PR_TOKEN_LEGACY}"
          fi
          export GH_TOKEN

          if [ -z "${DEPLOYMENT_URL}" ]; then
            echo "⚠️ No deployment URL available; skipping About homepage update."
            exit 0
          fi

          if [ -z "${GH_TOKEN}" ]; then
            echo "⚠️ GH_PR_TOKEN/GHPR_TOKEN is not set; skipping About homepage update."
            exit 0
          fi

          if gh api --method PATCH "repos/${{ github.repository }}" -f homepage="${DEPLOYMENT_URL}" >/dev/null 2>&1; then
            echo "✅ Updated repository About homepage to ${DEPLOYMENT_URL}"
          else
            echo "⚠️ Failed to update repository About homepage (token may lack admin rights)."
          fi

  # ══════════════════════════════════════════════════════════════════
  # Version Tag — MAIN Release
  # ══════════════════════════════════════════════════════════════════
  version-main-release:
    name: "Version Tag — MAIN Release"
    needs: [deploy-prod, update-about-link]
    if: >-
      always() &&
      github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.dry_run != 'true') &&
      (needs.deploy-prod.result == 'success' || needs.deploy-prod.result == 'skipped')
    uses: ImplementSprint/Central-Template/.github/workflows/versioning.yml@main
    with:
      mode: main

  # ══════════════════════════════════════════════════════════════════
  # Docker Build & Push (GHCR) — main only
  # ══════════════════════════════════════════════════════════════════
  docker-main:
    name: "GHCR — ${{ needs.systems-config.outputs.system_name }}"
    needs: [version-main-release, systems-config]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_deploy == 'true' && github.event.inputs.dry_run != 'true'))
    uses: ImplementSprint/Central-Template/.github/workflows/docker-build.yml@main
    with:
      working-directory: ${{ needs.systems-config.outputs.working_dir }}
      image-name: ${{ needs.systems-config.outputs.image_name }}
      release-tag: ${{ needs.version-main-release.outputs.version_tag }}
      push-image: true
      scan-vulnerabilities: true
    secrets: inherit

  # ══════════════════════════════════════════════════════════════════
  # Promotion: Create PR → UAT
  # ══════════════════════════════════════════════════════════════════
  create-pr-to-uat:
    name: "Create PR → UAT"
    needs: [backend, sonarcloud, version-test, deploy-test, systems-config]
    if: >-
      always() &&
      github.ref == 'refs/heads/test' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped') &&
      needs.version-test.result == 'success' &&
      (needs.deploy-test.result == 'success' || needs.deploy-test.result == 'skipped')
    uses: ImplementSprint/Central-Template/.github/workflows/promotion.yml@main
    with:
      pipeline-kind: single
      direction: test-to-uat
      system1-name: ${{ needs.systems-config.outputs.system_name }}
      system1-url: ${{ needs.deploy-test.outputs.deployment_url }}
      system1-result: ${{ needs.backend.result }}
      version-tag: ${{ needs.version-test.outputs.version_tag }}
      tests-status: ${{ needs.backend.result }}
      lint-status: ${{ needs.backend.result }}
      security-status: ${{ needs.backend.result }}
      sonar-status: ${{ needs.sonarcloud.result }}
      pipeline-result: ${{ (needs.backend.result == 'success' || needs.backend.result == 'skipped') && 'success' || (needs.backend.result == 'cancelled' && 'cancelled' || 'failure') }}
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}

  # ══════════════════════════════════════════════════════════════════
  # Promotion: Create PR → Main
  # ══════════════════════════════════════════════════════════════════
  create-pr-to-main:
    name: "Create PR → Main"
    needs: [backend, sonarcloud, deploy-uat, systems-config]
    if: >-
      always() &&
      github.ref == 'refs/heads/uat' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.run_promotion == 'true') &&
      (needs.backend.result == 'success' || needs.backend.result == 'skipped') &&
      (needs.deploy-uat.result == 'success' || needs.deploy-uat.result == 'skipped')
    uses: ImplementSprint/Central-Template/.github/workflows/promotion.yml@main
    with:
      pipeline-kind: single
      direction: uat-to-main
      system1-name: ${{ needs.systems-config.outputs.system_name }}
      system1-url: ${{ needs.deploy-uat.outputs.deployment_url }}
      system1-result: ${{ needs.backend.result }}
      tests-status: ${{ needs.backend.result }}
      lint-status: ${{ needs.backend.result }}
      security-status: ${{ needs.backend.result }}
      sonar-status: ${{ needs.sonarcloud.result }}
      pipeline-result: ${{ (needs.backend.result == 'success' || needs.backend.result == 'skipped') && 'success' || (needs.backend.result == 'cancelled' && 'cancelled' || 'failure') }}
      dry-run: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
    secrets:
      PR_TOKEN: ${{ secrets.GH_PR_TOKEN }}

  # ══════════════════════════════════════════════════════════════════
  # Pipeline Summary
  # ══════════════════════════════════════════════════════════════════
  pipeline-summary:
    name: "Pipeline Summary"
    needs: [backend, systems-config]
    if: always()
    uses: ImplementSprint/Central-Template/.github/workflows/pipeline-summary.yml@main
    with:
      pipeline-kind: single
      system1-name: ${{ needs.systems-config.outputs.system_name }}
      system1-result: ${{ needs.backend.result }}

  # ══════════════════════════════════════════════════════════════════
  # Auto Revert on Failure
  # ══════════════════════════════════════════════════════════════════
  auto-revert-on-failure:
    name: "Auto Revert on Failure"
    needs:
      [
        systems-config,
        backend,
        sonarcloud,
        version-test,
        deploy-test,
        deploy-uat,
        production-gate,
        deploy-prod,
        update-about-link,
        version-main-release,
        docker-main,
        create-pr-to-uat,
        create-pr-to-main,
        pipeline-summary,
      ]
    if: >-
      always() &&
      github.event_name == 'push' &&
      contains(needs.*.result, 'failure') &&
      !contains(github.event.head_commit.message, '[skip-revert]') &&
      !contains(github.event.head_commit.message, '[skip ci]') &&
      !contains(github.event.head_commit.message, '[ci skip]') &&
      !startsWith(github.event.head_commit.message, 'Revert "')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Create rollback commit
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin "${BRANCH_NAME}" --depth=50
          git checkout -B "${BRANCH_NAME}" "origin/${BRANCH_NAME}"

          export GIT_EDITOR=:

          if git revert --no-edit "${GITHUB_SHA}"; then
            git commit --amend -m "$(git log -1 --pretty=%B) [skip ci] [skip-revert]"
            echo "✅ Created revert commit from ${GITHUB_SHA}."
          elif git revert -m 1 --no-edit "${GITHUB_SHA}"; then
            git commit --amend -m "$(git log -1 --pretty=%B) [skip ci] [skip-revert]"
            echo "✅ Created merge-revert commit from ${GITHUB_SHA}."
          else
            git revert --abort || true
            SHORT_SHA="${GITHUB_SHA:0:7}"
            git commit --allow-empty -m "ci(auto-revert): manual rollback required for ${SHORT_SHA} [skip ci] [skip-revert]"
            echo "⚠️ Automatic revert conflicted; created marker commit for manual rollback."
          fi

          git push origin "HEAD:${BRANCH_NAME}"

  # ══════════════════════════════════════════════════════════════════
  # Notify Pipeline Status
  # ══════════════════════════════════════════════════════════════════
  notify-pipeline:
    name: "Notify Pipeline Status"
    needs: [pipeline-summary, backend, sonarcloud, systems-config, deploy-test, deploy-uat, deploy-prod, auto-revert-on-failure]
    if: always()
    uses: ImplementSprint/Central-Template/.github/workflows/notifications.yml@main
    with:
      status: ${{ (needs.backend.result == 'success' || needs.backend.result == 'skipped') && 'success' || (needs.backend.result == 'cancelled' && 'cancelled' || 'failure') }}
      system-dir: Backend
      pipeline-type: Backend Master
      error-details: ${{ needs.backend.result != 'success' && needs.backend.result != 'skipped' && 'Master backend pipeline reported failures.' || '' }}
      deployment-url: ${{ github.ref_name == 'main' && needs.deploy-prod.outputs.deployment_url || (github.ref_name == 'uat' && needs.deploy-uat.outputs.deployment_url || (github.ref_name == 'test' && needs.deploy-test.outputs.deployment_url || '')) }}
      deployment-urls-json: ${{ format('{{"{0}":"{1}"}}', needs.systems-config.outputs.system_name, (github.ref_name == 'main' && needs.deploy-prod.outputs.deployment_url || (github.ref_name == 'uat' && needs.deploy-uat.outputs.deployment_url || (github.ref_name == 'test' && needs.deploy-test.outputs.deployment_url || '')))) }}
      success-image-url: ${{ vars.JED_SUCCESS_IMAGE_URL }}
      failure-image-url: ${{ vars.JED_FAIL_IMAGE_URL }}
      cancelled-image-url: ${{ vars.JED_CANCELLED_IMAGE_URL }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
